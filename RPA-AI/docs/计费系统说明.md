# SaaS计费系统说明文档

## 1. 系统概述

本计费系统是一个面向SaaS服务的多模式计费解决方案，支持订阅制、按量计费、Token计费等多种计费模式，并提供灵活的折扣和优惠策略。

## 2. 计费模式

### 2.1 订阅计划
- 免费体验（5次）
- 分钟套餐
  - 5分钟：¥9.9
  - 30分钟：¥29.9
  - 60分钟：¥49.9
  - 480分钟：¥199
  - 24小时：¥399

- 固定时长
  - 7天：¥999
  - 30天：¥2999
  - 90天：¥7999
  - 1年：¥19999
  - 3年：¥49999

### 2.2 Token计费
- 基础费率：¥0.01/token
- 批量折扣：
  - 1万tokens：90%
  - 5万tokens：80%
  - 10万tokens：70%

### 2.3 会员等级
- 青铜会员：95折
- 白银会员：90折
- 黄金会员：85折
- 铂金会员：80折

## 3. 核心组件

### 3.1 计费服务（BillingService）
```python
billing_service = BillingService()

# 计算订阅价格
price_info = billing_service.calculate_subscription_price(
    plan_id="30d",
    user_info={"vip_level": "gold"}
)

# 计算Token价格
token_price = billing_service.calculate_token_price(
    token_count=10000,
    user_info={"vip_level": "silver"}
)

# 计算按时计费
time_price = billing_service.calculate_time_based_price(
    minutes=60,
    user_info={"vip_level": "bronze"}
)
```

### 3.2 配置管理
```json
{
    "subscription_plans": {
        "free": {
            "quota": 5,
            "price": 0
        },
        "time_based": {
            "5min": {
                "duration": 300,
                "price": 9.9
            }
        }
    }
}
```

## 4. 折扣规则

### 4.1 折扣类型
- 会员折扣
- 批量折扣
- 推荐折扣
- 活动折扣

### 4.2 折扣叠加
- 最多支持三重折扣
- 按优先级应用
- 自动选择最优方案

## 5. 使用说明

### 5.1 初始化配置
1. 创建配置文件
2. 设置计费规则
3. 配置折扣策略
4. 启用计费服务

### 5.2 接口调用
```python
# 创建订单
order = await billing_service.create_order(
    user_id="user123",
    plan_id="30d"
)

# 计算价格
price = await billing_service.calculate_price(
    order_id="order123"
)

# 应用折扣
final_price = await billing_service.apply_discounts(
    price=price,
    user_id="user123"
)
```

## 6. 数据管理

### 6.1 订单记录
- 订单ID
- 用户信息
- 计费明细
- 折扣信息
- 支付状态

### 6.2 用量统计
- Token消耗
- 时长统计
- 折扣统计
- 费用汇总

## 7. 安全措施

### 7.1 数据安全
- 加密存储
- 访问控制
- 操作审计
- 备份恢复

### 7.2 计费安全
- 余额校验
- 限额控制
- 异常检测
- 自动预警

## 8. 最佳实践

### 8.1 性能优化
- 使用缓存
- 异步处理
- 批量操作
- 定时任务

### 8.2 错误处理
- 参数验证
- 异常捕获
- 日志记录
- 失败重试

## 9. 常见问题

### 9.1 计费问题
1. 价格计算错误
   - 检查计费规则
   - 验证折扣配置
   - 确认用户等级
   - 查看操作日志

2. 折扣未生效
   - 检查折扣条件
   - 验证用户资格
   - 确认优先级
   - 测试折扣规则

### 9.2 系统维护
- 定期检查日志
- 更新计费规则
- 清理过期数据
- 备份重要信息

## 10. 更新日志

### v1.0.0 (2025-03-18)
- 支持多种计费模式
- 实现灵活折扣策略
- 提供完整API接口
- 支持数据统计分析
